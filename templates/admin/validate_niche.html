{% extends 'modern_admin_base.html' %}

{% block title %}Validate Niche - Admin - NICOLE{% endblock %}
{% block page_title %}Niche Validator{% endblock %}
{% block page_description %}Validate if a channel's niche is profitable and replicable{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">
    <!-- Validator Form -->
    <div class="glass-effect rounded-xl p-8 mb-6">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
            <div class="flex items-center">
                <span class="text-2xl mr-3">‚ÑπÔ∏è</span>
                <div>
                    <p class="font-semibold text-blue-800">How it works:</p>
                    <p class="text-blue-700">Enter a YouTube channel URL and we'll analyze if the niche has enough similar successful channels to be profitable.</p>
                </div>
            </div>
        </div>

        <form id="validateForm">
            <div class="mb-6">
                <label for="channel_url" class="block text-sm font-medium text-gray-700 mb-2">YouTube Channel URL</label>
                <input type="url" id="channel_url" name="channel_url" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-lg"
                       placeholder="https://youtube.com/@channelname or https://youtube.com/channel/UC...">
                <p class="text-sm text-gray-500 mt-1">Paste the full URL of the channel you want to validate</p>
            </div>

            <button type="submit" id="validateBtn"
                    class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:from-yellow-600 hover:to-orange-700 transition-all">
                ‚úÖ Validate Niche
            </button>
        </form>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" style="display: none;">
        <div class="glass-effect rounded-xl p-12 text-center">
            <div class="w-20 h-20 mx-auto mb-6">
                <svg class="animate-spin h-20 w-20 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Analyzing Channel...</h3>
            <p class="text-gray-600 mb-6" id="loadingMessage">This may take a few minutes. We're searching for similar successful channels...</p>
            <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-yellow-500 to-orange-600 h-full flex items-center justify-center text-white text-sm font-semibold transition-all duration-500" style="width: 0%">
                    0%
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <div class="glass-effect rounded-xl overflow-hidden" id="resultsContainer">
            <!-- Results will be populated here -->
        </div>
    </div>
</div>

<script>
document.getElementById('validateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const channelUrl = document.getElementById('channel_url').value;
    const validateBtn = document.getElementById('validateBtn');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    
    loadingSection.style.display = 'block';
    resultsSection.style.display = 'none';
    validateBtn.disabled = true;
    
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            const bar = document.getElementById('progressBar');
            bar.style.width = progress + '%';
            bar.textContent = progress + '%';
        }
    }, 2000);
    
    try {
        const response = await fetch('/admin/api/validate-niche', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channel_url: channelUrl })
        });
        
        const data = await response.json();
        
        clearInterval(progressInterval);
        const bar = document.getElementById('progressBar');
        bar.style.width = '100%';
        bar.textContent = '100%';
        
        setTimeout(() => {
            loadingSection.style.display = 'none';
            resultsSection.style.display = 'block';
            validateBtn.disabled = false;
            displayResults(data);
        }, 500);
        
    } catch (error) {
        clearInterval(progressInterval);
        loadingSection.style.display = 'none';
        validateBtn.disabled = false;
        alert('Error validating niche: ' + error.message);
    }
});

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    const qualified = data.qualified;
    
    let html = `
        <div class="bg-gradient-to-r ${qualified ? 'from-green-500 to-emerald-600' : 'from-red-500 to-red-600'} text-white px-6 py-4">
            <h2 class="text-2xl font-bold">${qualified ? '‚úÖ Niche Qualified!' : '‚ùå Niche Not Qualified'}</h2>
        </div>
        <div class="p-8">
            <div class="${qualified ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'} border-l-4 p-4 rounded-lg mb-6">
                <p class="font-medium ${qualified ? 'text-green-800' : 'text-red-800'}">${data.message}</p>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <p class="text-3xl font-bold text-indigo-600">${data.similar_channels}</p>
                    <p class="text-sm text-gray-600">Similar Channels</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <p class="text-3xl font-bold text-purple-600">${data.avg_duration.toFixed(1)} min</p>
                    <p class="text-sm text-gray-600">Avg Duration</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <p class="text-3xl font-bold text-orange-600">${data.view_threshold.toLocaleString()}</p>
                    <p class="text-sm text-gray-600">View Threshold</p>
                </div>
            </div>
    `;
    
    if (data.series && data.series.length > 0) {
        html += `
            <h3 class="text-xl font-bold text-gray-900 mb-4">üéØ Top Series Identified</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">
                ${data.series.map(s => `
                    <div class="bg-blue-50 rounded-lg px-4 py-3">
                        <p class="font-medium text-blue-900">${s}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    if (data.channels && data.channels.length > 0) {
        html += `
            <h3 class="text-xl font-bold text-gray-900 mb-4">üì∫ Similar Channels</h3>
            <div class="space-y-3">
                ${data.channels.map(ch => `
                    <div class="border border-gray-200 rounded-lg p-4 bg-white flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-900">${ch.title}</p>
                            <p class="text-sm text-gray-600">${ch.age_days} days old ‚Ä¢ ${ch.total_views.toLocaleString()} views</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}
</script>

{% endblock %}
