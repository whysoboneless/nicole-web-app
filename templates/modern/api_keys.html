{% extends "modern_base.html" %}

{% block title %}API Keys - Nicole AI{% endblock %}

{% block page_title %}API Keys{% endblock %}
{% block page_description %}Manage your API keys and service integrations{% endblock %}

{% block content %}
<div x-data="apiKeysPage()">
    <!-- Core Setup Notice -->
    <div class="glass-effect rounded-xl p-6 mb-8 bg-gradient-to-r from-blue-50 to-indigo-50">
        <div class="flex items-start space-x-4">
            <div class="text-3xl">üöÄ</div>
            <div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Core API Setup</h3>
                <p class="text-gray-700 mb-3">
                    Get started with YouTube automation using these essential services:
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">üß† Anthropic Claude (Required)</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">üì∫ YouTube API (Optional)</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">üîÑ Replicate (Optional)</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">üéôÔ∏è ElevenLabs (Optional)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Active Keys</p>
                    <p class="text-2xl font-bold text-green-600" x-text="activeKeys">3</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">üîë</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Services Connected</p>
                    <p class="text-2xl font-bold text-blue-600" x-text="connectedServices">5</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">üîó</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Last Updated</p>
                    <p class="text-2xl font-bold text-purple-600" x-text="lastUpdated">2d ago</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">‚è∞</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Security Score</p>
                    <p class="text-2xl font-bold text-green-600" x-text="securityScore + '%'">98%</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">üõ°Ô∏è</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- API Keys List -->
        <div class="lg:col-span-2">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">üîê API Keys</h3>
                    <button @click="showAddKeyModal = true" 
                            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all flex items-center space-x-2">
                        <span>‚ûï</span>
                        <span>Add New Key</span>
                    </button>
                </div>

                <!-- API Keys Grid -->
                <div class="space-y-4">
                    <template x-for="apiKey in apiKeys" :key="apiKey.id">
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center" 
                                         :class="getServiceColor(apiKey.service)">
                                        <span class="text-xl" x-text="apiKey.icon"></span>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900" x-text="apiKey.name"></h4>
                                        <p class="text-sm text-gray-600" x-text="apiKey.description"></p>
                                        <div class="flex items-center space-x-4 mt-1 text-xs text-gray-500">
                                            <span>Added: <span x-text="apiKey.dateAdded"></span></span>
                                            <span>Last used: <span x-text="apiKey.lastUsed"></span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="flex items-center space-x-1">
                                        <div :class="apiKey.status === 'active' ? 'bg-green-500' : 'bg-red-500'" 
                                             class="w-2 h-2 rounded-full"></div>
                                        <span class="text-sm" 
                                              :class="apiKey.status === 'active' ? 'text-green-600' : 'text-red-600'" 
                                              x-text="apiKey.status"></span>
                                    </div>
                                    <button @click="editKey(apiKey)" 
                                            class="text-blue-600 hover:text-blue-700 p-2 rounded">
                                        ‚úèÔ∏è
                                    </button>
                                    <button @click="testKey(apiKey)" 
                                            class="text-green-600 hover:text-green-700 p-2 rounded">
                                        üß™
                                    </button>
                                    <button @click="deleteKey(apiKey)" 
                                            class="text-red-600 hover:text-red-700 p-2 rounded">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Key Preview -->
                            <div class="mt-3 bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div class="font-mono text-sm text-gray-600">
                                        <span x-show="apiKey.showKey" x-text="apiKey.key"></span>
                                        <span x-show="!apiKey.showKey">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    </div>
                                    <button @click="apiKey.showKey = !apiKey.showKey" 
                                            class="text-gray-500 hover:text-gray-700 text-sm">
                                        <span x-text="apiKey.showKey ? 'üôà Hide' : 'üëÅÔ∏è Show'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="apiKeys.length === 0" class="text-center py-12">
                    <div class="text-6xl mb-4">üîë</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No API Keys Added</h3>
                    <p class="text-gray-600 mb-4">Add your first API key to get started with integrations</p>
                    <button @click="showAddKeyModal = true" 
                            class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors">
                        Add Your First API Key
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Available Services -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">üìã Available Services</h3>
                <div class="space-y-3">
                    <template x-for="service in availableServices" :key="service.name">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <span class="text-xl" x-text="service.icon"></span>
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium text-sm" x-text="service.name"></span>
                                        <span x-show="service.required" 
                                              class="px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-medium">
                                            Required
                                        </span>
                                        <span x-show="!service.required" 
                                              class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                            Optional
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500" x-text="service.category"></div>
                                </div>
                            </div>
                            <button @click="addServiceKey(service)" 
                                    :disabled="hasService(service.name)"
                                    :class="hasService(service.name) ? 'text-green-500 cursor-not-allowed' : 'text-blue-600 hover:text-blue-700'"
                                    class="text-sm">
                                <span x-text="hasService(service.name) ? '‚úÖ' : '‚ûï'"></span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">üõ°Ô∏è Security Tips</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex items-start space-x-2">
                        <span class="text-green-500 mt-0.5">‚úì</span>
                        <span>Never share API keys in public repositories</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-green-500 mt-0.5">‚úì</span>
                        <span>Rotate keys regularly for better security</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-green-500 mt-0.5">‚úì</span>
                        <span>Monitor usage to detect unauthorized access</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-green-500 mt-0.5">‚úì</span>
                        <span>Use environment variables in production</span>
                    </div>
                </div>
            </div>

            <!-- Usage Statistics -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">üìä Usage This Month</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">üß† Claude API Calls</span>
                        <span class="font-semibold">2,847</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">üì∫ YouTube Requests</span>
                        <span class="font-semibold">1,234</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">üîÑ Replicate Predictions</span>
                        <span class="font-semibold">456</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">üéôÔ∏è ElevenLabs Characters</span>
                        <span class="font-semibold">12,890</span>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 font-medium">üí∞ Total API Costs</span>
                            <span class="font-bold text-green-600">$47.23</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit API Key Modal -->
    <div x-show="showAddKeyModal" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4" @click.away="showAddKeyModal = false">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <span x-text="editingKey ? 'Edit API Key' : 'Add New API Key'"></span>
            </h3>
            
            <form @submit.prevent="saveKey()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service</label>
                        <select x-model="keyForm.service" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select a service...</option>
                            <template x-for="service in availableServices" :key="service.name">
                                <option :value="service.name" x-text="service.icon + ' ' + service.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key Name</label>
                        <input type="text" x-model="keyForm.name" required
                               placeholder="e.g., Production OpenAI Key"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                        <div class="relative">
                            <input :type="showKeyInput ? 'text' : 'password'" 
                                   x-model="keyForm.key" required
                                   placeholder="Enter your API key"
                                   class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="button" @click="showKeyInput = !showKeyInput" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <span x-text="showKeyInput ? 'üôà' : 'üëÅÔ∏è'"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea x-model="keyForm.description" rows="2"
                                  placeholder="Brief description of this key's purpose"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <h4 class="font-semibold text-yellow-900 text-sm mb-1">üîí Security Notice</h4>
                        <p class="text-yellow-800 text-xs">
                            API keys are encrypted and stored securely. Only you can view and manage your keys.
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" @click="showAddKeyModal = false" 
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        <span x-text="editingKey ? 'Update Key' : 'Add Key'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function apiKeysPage() {
    return {
        // Stats - calculated from actual data
        get activeKeys() {
            return this.apiKeys.length;
        },
        get connectedServices() {
            return this.apiKeys.filter(key => key.status === 'active').length;
        },
        get lastUpdated() {
            if (this.apiKeys.length === 0) return 'Never';
            const latest = this.apiKeys.reduce((latest, key) => {
                const keyDate = new Date(key.updated_at || key.created_at);
                return keyDate > latest ? keyDate : latest;
            }, new Date(0));
            const now = new Date();
            const diffDays = Math.floor((now - latest) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return '1 day ago';
            return `${diffDays} days ago`;
        },
        get securityScore() {
            // Simple security score based on having keys and recent updates
            let score = 0;
            if (this.apiKeys.length > 0) score += 30;
            if (this.apiKeys.some(key => key.service === 'Anthropic Claude')) score += 40;
            if (this.apiKeys.some(key => key.service.includes('YouTube'))) score += 20;
            if (this.apiKeys.length > 2) score += 10;
            return Math.min(score, 100);
        },
        
        // Modal state
        showAddKeyModal: false,
        editingKey: null,
        showKeyInput: false,
        
        // Form data
        keyForm: {
            service: '',
            name: '',
            key: '',
            description: ''
        },
        
        // API Keys data - loaded from backend
        apiKeys: {{ api_keys | tojson if api_keys else '[]' | safe }},
        
        // Available services
        availableServices: [
            { name: 'Anthropic Claude', icon: 'üß†', category: 'AI/ML', required: true },
            { name: 'YouTube Data API', icon: 'üì∫', category: 'YouTube', required: false },
            { name: 'YouTube Analytics API', icon: 'üìä', category: 'YouTube', required: false },
            { name: 'Replicate', icon: 'üîÑ', category: 'AI/ML', required: false },
            { name: 'ElevenLabs', icon: 'üéôÔ∏è', category: 'Voice', required: false }
        ],
        
        // Methods
        getServiceColor(service) {
            const colors = {
                'Anthropic Claude': 'bg-orange-100 text-orange-700',
                'YouTube Data API': 'bg-red-100 text-red-700',
                'YouTube Analytics API': 'bg-red-100 text-red-700',
                'Replicate': 'bg-blue-100 text-blue-700',
                'ElevenLabs': 'bg-purple-100 text-purple-700'
            };
            return colors[service] || 'bg-gray-100 text-gray-700';
        },
        
        hasService(serviceName) {
            return this.apiKeys.some(key => key.service === serviceName);
        },
        
        addServiceKey(service) {
            if (this.hasService(service.name)) return;
            
            this.keyForm = {
                service: service.name,
                name: `${service.name} Key`,
                key: '',
                description: `API key for ${service.name} integration`
            };
            this.editingKey = null;
            this.showAddKeyModal = true;
        },
        
        editKey(apiKey) {
            this.keyForm = {
                service: apiKey.service,
                name: apiKey.name,
                key: apiKey.key,
                description: apiKey.description
            };
            this.editingKey = apiKey;
            this.showAddKeyModal = true;
        },
        
        async saveKey() {
            try {
                const response = await fetch('/api/save-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: this.keyForm.service,
                        name: this.keyForm.name,
                        key: this.keyForm.key,
                        description: this.keyForm.description
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ API key saved successfully!');
                    // Reload the page to get updated data
                    window.location.reload();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error saving API key: ${error.message}`);
            }
            
            this.showAddKeyModal = false;
            this.keyForm = { service: '', name: '', key: '', description: '' };
            this.editingKey = null;
        },
        
        async testKey(apiKey) {
            try {
                const response = await fetch('/api/test-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: apiKey.service
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`üß™ Testing ${apiKey.service} API key...\n\n‚úÖ ${result.message}`);
                } else {
                    alert(`üß™ Testing ${apiKey.service} API key...\n\n‚ùå ${result.error}`);
                }
            } catch (error) {
                alert(`üß™ Testing ${apiKey.service} API key...\n\n‚ùå Error: ${error.message}`);
            }
        },
        
        async deleteKey(apiKey) {
            if (confirm(`Are you sure you want to delete the ${apiKey.name} API key?\n\nThis action cannot be undone.`)) {
                try {
                    const response = await fetch('/api/delete-api-key', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            service: apiKey.service
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('üóëÔ∏è API key deleted successfully!');
                        // Reload the page to get updated data
                        window.location.reload();
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`‚ùå Error deleting API key: ${error.message}`);
                }
            }
        }
    }
}
</script>
{% endblock %}
