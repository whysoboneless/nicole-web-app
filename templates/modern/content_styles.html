{% extends "modern_base.html" %}

{% block title %}Content Styles - Nicole AI{% endblock %}
{% block page_title %}Content Style Library{% endblock %}
{% block page_description %}Reverse-engineer any content style and reuse it across infinite niches{% endblock %}

{% block content %}
<div x-data="contentStylesApp()" x-init="init()">
    
    <!-- Header -->
    <div class="glass-effect rounded-xl p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Content Style Library</h1>
                <p class="text-gray-600 mt-2">
                    Reverse-engineer any content style and reuse it across infinite niches
                </p>
            </div>
            <button @click="showCreateModal = true" 
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                + Reverse Engineer New Style
            </button>
        </div>
    </div>
    
    <!-- Styles Grid -->
    <div x-show="!loading && contentStyles.length > 0" 
         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        <template x-for="style in contentStyles" :key="style._id">
            <div class="glass-effect rounded-xl p-6 card-hover">
                
                <!-- Preview -->
                <div class="aspect-video bg-gradient-to-br from-purple-400 to-blue-500 rounded-lg mb-4 flex items-center justify-center">
                    <svg class="h-16 w-16 text-white opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </div>
                
                <!-- Info -->
                <h3 class="text-xl font-bold mb-2" x-text="style.display_name"></h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-2" x-text="style.description"></p>
                
                <!-- Stats -->
                <div class="grid grid-cols-3 gap-2 mb-4 text-xs text-gray-500">
                    <div class="text-center bg-gray-50 rounded p-2">
                        <div class="font-bold text-lg text-gray-900" x-text="style.reference_videos?.length || 0"></div>
                        <div>References</div>
                    </div>
                    <div class="text-center bg-gray-50 rounded p-2">
                        <div class="font-bold text-lg text-gray-900" x-text="Object.keys(style.vfx_profile?.automation_workflows || {}).length"></div>
                        <div>Workflows</div>
                    </div>
                    <div class="text-center bg-gray-50 rounded p-2">
                        <div class="font-bold text-lg text-gray-900" x-text="style.remotion_components?.length || 0"></div>
                        <div>Components</div>
                    </div>
                </div>
                
                <!-- Confidence Score -->
                <div x-show="style.vfx_profile?.confidence_score" 
                     class="mb-4 bg-blue-50 border border-blue-200 rounded p-3">
                    <div class="text-xs text-blue-800 font-medium mb-1">Confidence Score</div>
                    <div class="flex items-center">
                        <div class="flex-1 bg-blue-200 rounded-full h-2 mr-3">
                            <div class="bg-blue-600 h-2 rounded-full transition-all" 
                                 :style="`width: ${(style.vfx_profile?.confidence_score || 0) * 100}%`"></div>
                        </div>
                        <span class="text-sm font-bold text-blue-900" 
                              x-text="`${Math.round((style.vfx_profile?.confidence_score || 0) * 100)}%`"></span>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="mb-4">
                    <span x-show="style.status === 'active'" 
                          class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                        ‚úì Ready to Use
                    </span>
                    <span x-show="style.status === 'analyzing'" 
                          class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                        ‚è≥ Analyzing...
                    </span>
                    <span x-show="style.status === 'draft'" 
                          class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">
                        üìù Draft
                    </span>
                </div>
                
                <!-- Actions -->
                <div class="flex space-x-2 mb-2">
                    <button @click="viewStyle(style._id)" 
                            class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                        View Details
                    </button>
                    <button @click="applyStyle(style)" 
                            :disabled="style.status !== 'active'"
                            :class="style.status === 'active' ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                            class="flex-1 px-4 py-2 rounded-lg transition-colors font-medium">
                        Use Style
                    </button>
                </div>
                
                <!-- Secondary Actions -->
                <div class="flex space-x-2">
                    <button x-show="style.status === 'analyzing'" 
                            @click="retryAnalysis(style._id)"
                            class="flex-1 px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors text-sm font-medium">
                        üîÑ Retry
                    </button>
                    <button @click="deleteStyle(style._id, style.display_name)" 
                            class="flex-1 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Loading State -->
    <div x-show="loading" class="glass-effect rounded-xl p-12 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-gray-600">Loading content styles...</p>
    </div>
    
    <!-- Empty State -->
    <div x-show="!loading && contentStyles.length === 0" 
         class="glass-effect rounded-xl p-12 text-center">
        <div class="text-6xl mb-4">üé®</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No content styles yet</h3>
        <p class="text-gray-600 mb-6">Get started by reverse-engineering your first content style</p>
        <button @click="showCreateModal = true" 
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors">
            Create Your First Style
        </button>
    </div>
    
    <!-- Create Modal with 3-Stage Selection -->
    <div x-show="showCreateModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
         @click.self="showCreateModal = false">
        
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Reverse Engineer Content Style</h2>
            
            <!-- Stage 1: Project Selection -->
            <div x-show="currentCreateStage === 'project'">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Project</h3>
                    {% if user_groups %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for project in user_groups %}
                        <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-indigo-500 transition-colors"
                             :class="selectedProject?.id === '{{ project._id }}' ? 'border-indigo-500 bg-indigo-50' : ''"
                             @click="selectProject({
                                 id: '{{ project._id }}',
                                 name: '{{ project.name or "Unnamed Project" }}',
                                 competitors: {{ project.competitor_channels|length if project.competitor_channels else 0 }}
                             })">
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-white text-xl">üìä</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ project.name or "Unnamed Project" }}</h3>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600">Competitors</span>
                                        <span class="font-medium text-gray-900">{{ project.competitor_channels|length if project.competitor_channels else 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <p class="text-gray-600">No projects found. Create a project first.</p>
                    </div>
                    {% endif %}
                </div>
                <div class="flex justify-end space-x-3">
                    <button @click="showCreateModal = false" 
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button @click="loadProjectData()" 
                            :disabled="!selectedProject"
                            :class="selectedProject ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                            class="px-6 py-2 rounded-lg transition-colors font-medium">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Stage 2: Series & Theme Selection -->
            <div x-show="currentCreateStage === 'selection'">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Select Series & Theme</h3>
                        <button @click="currentCreateStage = 'project'" class="text-gray-600 hover:text-gray-900 font-medium text-sm">
                            ‚Üê Back to Projects
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Series Selection -->
                        <div class="glass-effect rounded-xl p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">üì∫ Select Series</h4>
                            <div x-show="seriesData.length === 0" class="text-center py-8">
                                <p class="text-gray-600">No series available</p>
                            </div>
                            <div x-show="seriesData.length > 0" class="space-y-3 max-h-96 overflow-y-auto">
                                <template x-for="(series, index) in seriesData" :key="index">
                                    <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-indigo-500 transition-colors"
                                         :class="selectedSeries?.name === series.name ? 'border-indigo-500 bg-indigo-50' : ''"
                                         @click="selectSeries(series)">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h5 class="font-medium text-gray-900" x-text="series.name"></h5>
                                                <p class="text-sm text-gray-600" x-text="(series.themes || []).length + ' themes'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Theme Selection -->
                        <div class="glass-effect rounded-xl p-6">
                            <h4 class="text-md font-semibold text-gray-900 mb-4">üé® Select Theme</h4>
                            <div x-show="!selectedSeries" class="text-center py-8">
                                <p class="text-gray-600">Select a series first</p>
                            </div>
                            <div x-show="selectedSeries && (!selectedSeries.themes || selectedSeries.themes.length === 0)" class="text-center py-8">
                                <p class="text-gray-600">No themes available</p>
                            </div>
                            <div x-show="selectedSeries && selectedSeries.themes && selectedSeries.themes.length > 0" class="space-y-3 max-h-96 overflow-y-auto">
                                <template x-for="(theme, index) in (selectedSeries?.themes || [])" :key="index">
                                    <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-indigo-500 transition-colors"
                                         :class="selectedTheme?.name === theme.name ? 'border-indigo-500 bg-indigo-50' : ''"
                                         @click="selectTheme(theme)">
                                        <div>
                                            <h5 class="font-medium text-gray-900" x-text="theme.name"></h5>
                                            <p class="text-sm text-gray-600" x-text="(theme.video_count || 0) + ' videos'"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button @click="currentCreateStage = 'project'" 
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        ‚Üê Back
                    </button>
                    <button @click="extractVideoUrls()" 
                            :disabled="!selectedSeries || !selectedTheme"
                            :class="(selectedSeries && selectedTheme) ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                            class="px-6 py-2 rounded-lg transition-colors font-medium">
                        Extract Videos ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Stage 3: Preview & Confirm -->
            <div x-show="currentCreateStage === 'preview'">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Preview & Confirm</h3>
                        <button @click="currentCreateStage = 'selection'" class="text-gray-600 hover:text-gray-900 font-medium text-sm">
                            ‚Üê Back
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-700">Style Name <span class="text-gray-400 text-xs">(optional)</span></label>
                            <input x-model="newStyle.name" 
                                   type="text" 
                                   placeholder="Leave blank to auto-generate (e.g., Content Style 2024-01-15 14:30)"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">Auto-generated if left blank. This style can be reused across multiple series/themes.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-700">Description</label>
                            <textarea x-model="newStyle.description" 
                                      rows="3"
                                      placeholder="Describe what makes this style unique..."
                                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700">Platform *</label>
                                <select x-model="newStyle.platform" 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="youtube">YouTube</option>
                                    <option value="tiktok">TikTok</option>
                                    <option value="instagram">Instagram</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-700">Content Format *</label>
                                <select x-model="newStyle.contentFormat" 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="video">Video</option>
                                    <option value="slideshow">Slideshow (Image Carousel)</option>
                                    <option value="reels">Reels (Short Video)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1" x-show="newStyle.contentFormat === 'slideshow'">
                                    For Instagram/TikTok image carousels with text overlays
                                </p>
                            </div>
                        </div>
                        
                        <div x-show="newStyle.contentFormat === 'slideshow'" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <strong>Note:</strong> For slideshow styles, you'll need to provide Instagram/TikTok post URLs instead of video URLs. 
                                The system will extract carousel images and analyze text overlay patterns.
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-700">
                                Extracted Video URLs (<span x-text="extractedVideoUrls.length"></span> videos)
                            </label>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-48 overflow-y-auto">
                                <template x-for="(url, index) in extractedVideoUrls" :key="index">
                                    <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0">
                                        <span class="text-sm font-mono text-gray-700" x-text="url"></span>
                                        <button @click="extractedVideoUrls.splice(index, 1)" 
                                                class="text-red-600 hover:text-red-800 text-sm">
                                            Remove
                                        </button>
                                    </div>
                                </template>
                                <div x-show="extractedVideoUrls.length === 0" class="text-center py-4 text-gray-500">
                                    No videos extracted
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                Videos extracted from <span x-text="selectedProject?.name"></span> ‚Üí <span x-text="selectedSeries?.name"></span> ‚Üí <span x-text="selectedTheme?.name"></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button @click="currentCreateStage = 'selection'" 
                            :disabled="creating"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:bg-gray-100 transition-colors">
                        ‚Üê Back
                    </button>
                    <button @click="createStyle()" 
                            :disabled="creating || extractedVideoUrls.length < 3"
                            :class="(creating || extractedVideoUrls.length < 3) ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'"
                            class="px-6 py-2 rounded-lg transition-colors font-medium">
                        <span x-show="!creating">Start Analysis</span>
                        <span x-show="creating">Creating...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
</div>

<script>
function contentStylesApp() {
    return {
        contentStyles: [],
        showCreateModal: false,
        creating: false,
        loading: true,
        currentCreateStage: 'project',
        selectedProject: null,
        selectedSeries: null,
        selectedTheme: null,
        seriesData: [],
        extractedVideoUrls: [],
        newStyle: {
            name: '',
            description: '',
            platform: 'youtube',
            contentFormat: 'video'
        },
        
        // Data from server
        userGroups: {{ user_groups|tojson if user_groups else '[]'|safe }},
        allSeriesData: {{ all_series_data|tojson if all_series_data else '[]'|safe }},
        
        async init() {
            await this.loadStyles();
        },
        
        async loadStyles() {
            try {
                this.loading = true;
                const response = await fetch('/content-styles/api/list');
                if (response.ok) {
                    this.contentStyles = await response.json();
                }
            } catch (error) {
                console.error('Error loading styles:', error);
                alert('Failed to load content styles');
            } finally {
                this.loading = false;
            }
        },
        
        selectProject(project) {
            this.selectedProject = project;
        },
        
        loadProjectData() {
            if (!this.selectedProject) return;
            
            // Filter series data for selected project
            this.seriesData = this.allSeriesData.filter(s => s.group_id === this.selectedProject.id);
            this.selectedSeries = null;
            this.selectedTheme = null;
            this.currentCreateStage = 'selection';
        },
        
        selectSeries(series) {
            this.selectedSeries = series;
            this.selectedTheme = null;
        },
        
        selectTheme(theme) {
            this.selectedTheme = theme;
        },
        
        async extractVideoUrls() {
            if (!this.selectedProject || !this.selectedSeries || !this.selectedTheme) {
                alert('Please select project, series, and theme');
                return;
            }
            
            try {
                const response = await fetch('/content-styles/api/extract-videos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        group_id: this.selectedProject.id,
                        series_name: this.selectedSeries.name,
                        theme_name: this.selectedTheme.name,
                        limit: 3
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.video_urls) {
                    this.extractedVideoUrls = result.video_urls;
                    this.currentCreateStage = 'preview';
                } else {
                    alert('Failed to extract videos: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error extracting videos:', error);
                alert('Failed to extract videos');
            }
        },
        
        async createStyle() {
            if (this.extractedVideoUrls.length < 3) {
                alert('Need at least 3 video URLs');
                return;
            }
            
            try {
                this.creating = true;
                
                const response = await fetch('/content-styles/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: this.newStyle.name || '', // Will be auto-generated on server if empty
                        description: this.newStyle.description,
                        platform: this.newStyle.platform,
                        content_format: this.newStyle.contentFormat,
                        group_id: this.selectedProject.id,
                        series_name: this.selectedSeries.name,
                        theme_name: this.selectedTheme.name
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Analysis started!\n\nStyle ID: ${result.style_id}\n\nThis will take 10-30 minutes. You'll be notified when complete.`);
                    
                    // Reset form
                    this.newStyle = {name: '', description: '', platform: 'youtube', contentFormat: 'video'};
                    this.selectedProject = null;
                    this.selectedSeries = null;
                    this.selectedTheme = null;
                    this.extractedVideoUrls = [];
                    this.currentCreateStage = 'project';
                    this.showCreateModal = false;
                    
                    // Reload styles
                    await this.loadStyles();
                } else {
                    alert(`Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error creating style:', error);
                alert('Failed to create content style');
            } finally {
                this.creating = false;
            }
        },
        
        viewStyle(styleId) {
            window.location.href = `/content-styles/${styleId}`;
        },
        
        async applyStyle(style) {
            alert(`Apply "${style.display_name}" - Implementation coming soon`);
        },
        
        async deleteStyle(styleId, styleName) {
            if (!confirm(`Are you sure you want to delete "${styleName}"? This cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/content-styles/${styleId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Content style deleted successfully');
                    await this.loadStyles(); // Reload the list
                } else {
                    alert(`Error: ${result.error || 'Failed to delete content style'}`);
                }
            } catch (error) {
                console.error('Error deleting style:', error);
                alert('Failed to delete content style');
            }
        },
        
        async retryAnalysis(styleId) {
            if (!confirm('Restart analysis for this content style?')) {
                return;
            }
            
            try {
                console.log(`üîÑ Retrying analysis for style: ${styleId}`);
                const response = await fetch(`/content-styles/${styleId}/retry`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                console.log(`Response status: ${response.status}`);
                const result = await response.json();
                console.log('Response:', result);
                
                if (response.ok) {
                    alert('‚úÖ Analysis restarted! This will take 10-30 minutes.');
                    await this.loadStyles(); // Reload to show updated status
                } else {
                    alert(`Error: ${result.error || 'Failed to restart analysis'}`);
                }
            } catch (error) {
                console.error('Error retrying analysis:', error);
                alert(`Failed to restart analysis: ${error.message}`);
            }
        }
    };
}
</script>
{% endblock %}
