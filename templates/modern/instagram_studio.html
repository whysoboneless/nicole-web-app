{% extends "modern_admin_base.html" %}

{% block title %}Instagram Studio - Admin - Nicole AI{% endblock %}

{% block page_title %}Instagram Studio{% endblock %}
{% block page_description %}Mass redistribution platform for Instagram Reels and videos (Admin Only){% endblock %}

{% block content %}
<div x-data="instagramStudio()">
    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Connected Accounts</p>
                    <p class="text-2xl font-bold text-orange-600" x-text="connectedAccounts">0</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">üì±</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Videos Downloaded</p>
                    <p class="text-2xl font-bold text-yellow-600" x-text="videosDownloaded">0</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">‚¨áÔ∏è</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Videos Processed</p>
                    <p class="text-2xl font-bold text-amber-600" x-text="videosProcessed">0</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-amber-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">‚öôÔ∏è</span>
                </div>
            </div>
        </div>
        
        <div class="glass-effect rounded-xl p-6 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Videos Uploaded</p>
                    <p class="text-2xl font-bold text-green-600" x-text="videosUploaded">0</p>
                </div>
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl">‚¨ÜÔ∏è</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-8">
        <!-- Left: Account Management -->
        <div class="lg:col-span-1">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900">üì± Your Accounts</h3>
                    <button @click="showAddAccountModal = true" 
                            class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700 transition-all text-sm">
                        ‚ûï Add
                    </button>
                </div>

                <!-- Accounts List -->
                <div class="space-y-3">
                    <template x-for="account in instagramAccounts" :key="account.id">
                        <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold text-xs" x-text="account.username.charAt(0).toUpperCase()"></span>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900 text-sm" x-text="'@' + account.username"></h4>
                                        <p class="text-xs text-gray-600" x-text="account.niche"></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <button @click="editAccount(account)" 
                                            class="text-yellow-600 hover:text-yellow-700 p-1 rounded text-xs">
                                        ‚úèÔ∏è
                                    </button>
                                    <button @click="deleteAccount(account)" 
                                            class="text-red-600 hover:text-red-700 p-1 rounded text-xs">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="instagramAccounts.length === 0" class="text-center py-6">
                    <div class="text-3xl mb-2">üì±</div>
                    <p class="text-gray-600 text-sm mb-3">No accounts added</p>
                    <button @click="showAddAccountModal = true" 
                            class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm">
                        Add First Account
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: 2-Step Process -->
        <div class="lg:col-span-3 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Step 1: Steal Niche Content -->
                <div class="glass-effect rounded-xl p-6 card-hover">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-full flex items-center justify-center text-white font-bold">1</div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Steal Niche Content</h3>
                            <p class="text-xs text-gray-600">Download from specific niche accounts</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <input type="text" x-model="downloadForm.accountUrl" 
                               placeholder="https://instagram.com/poker_account"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <select x-model="downloadForm.niche" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select niche...</option>
                            <option value="poker">‚ô†Ô∏è Poker</option>
                            <option value="slots">üé∞ Slots</option>
                            <option value="blackjack">üÉè Blackjack</option>
                            <option value="roulette">üé≤ Roulette</option>
                            <option value="sports_betting">‚öΩ Sports Betting</option>
                            <option value="crypto_gambling">‚Çø Crypto Gambling</option>
                            <option value="general_gambling">üé∞ General Gambling</option>
                        </select>
                        <button @click="startDownload()" 
                                :disabled="!downloadForm.accountUrl || !downloadForm.niche"
                                class="w-full bg-gradient-to-r from-yellow-600 to-orange-700 text-white py-3 rounded-lg hover:from-yellow-700 hover:to-orange-800 transition-all disabled:opacity-50">
                            ‚¨áÔ∏è Steal Videos
                        </button>
                    </div>
                </div>

                <!-- Step 2: Process & Upload to Matching Niche -->
                <div class="glass-effect rounded-xl p-6 card-hover">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center text-white font-bold">2</div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Process & Upload</h3>
                            <p class="text-xs text-gray-600">Add StakeUs! and upload to matching niche accounts only</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <select x-model="processForm.promoTemplate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <option value="">StakeUs! overlay...</option>
                            <option value="stakeus_end_overlay">StakeUs! End (3s)</option>
                            <option value="custom_video_upload">Custom Video</option>
                        </select>
                        
                        <!-- Custom Video Upload -->
                        <div x-show="processForm.promoTemplate === 'custom_video_upload'" x-transition class="border-2 border-dashed border-gray-300 rounded-lg p-3 text-center">
                            <input type="file" @change="handleVideoUpload($event)" accept="video/*" class="hidden" id="stakeus-video-upload">
                            <label for="stakeus-video-upload" class="cursor-pointer">
                                <div class="text-xl mb-1">üìπ</div>
                                <div class="text-xs font-medium">Upload StakeUs! Video</div>
                            </label>
                            <div x-show="processForm.customVideoFile" class="mt-1 text-xs text-green-600" x-text="processForm.customVideoFile?.name"></div>
                        </div>
                        
                        <button @click="processAndUploadToNiche()" 
                                :disabled="!processForm.promoTemplate || videosDownloaded === 0"
                                class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-green-800 transition-all disabled:opacity-50">
                            üöÄ Process & Upload to Matching Niche
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Library -->
    <div class="glass-effect rounded-xl p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-6">üé¨ Video Library</h3>
        
        <!-- Videos Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
            <template x-for="video in videos" :key="video.id">
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="relative">
                        <img :src="video.thumbnail_url" :alt="video.caption" 
                             class="w-full h-24 object-cover bg-gray-100">
                        <div class="absolute top-1 right-1 px-2 py-1 rounded-full text-xs font-medium"
                             :class="getStatusColor(video.status)"
                             x-text="video.status"></div>
                    </div>
                    <div class="p-2">
                        <p class="text-xs text-gray-900 line-clamp-2" x-text="video.caption"></p>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="videos.length === 0" class="text-center py-12">
            <div class="text-6xl mb-4">üé¨</div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Videos Yet</h3>
            <p class="text-gray-600">Use Step 2 to steal content from Instagram accounts</p>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div x-show="showAddAccountModal" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4" @click.away="showAddAccountModal = false">
            <h3 class="text-xl font-bold text-gray-900 mb-2">Add Upload Account</h3>
            <p class="text-sm text-gray-600 mb-6">Add your Instagram account where you want to post StakeUs! content</p>
            
            <form @submit.prevent="addAccount()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instagram Username</label>
                        <input type="text" x-model="accountForm.username" required
                               placeholder="your_poker_page"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Password</label>
                        <input type="password" x-model="accountForm.password" required
                               placeholder="Instagram account password"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    
                    <!-- 2FA Code Field (only shown when needed) -->
                    <div x-show="show2FAField" x-transition>
                        <label class="block text-sm font-medium text-gray-700 mb-2">2FA Verification Code</label>
                        <input type="text" x-model="accountForm.verification_code"
                               placeholder="Enter 6-digit code from your phone/app"
                               maxlength="6"
                               class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                        <p class="text-xs text-yellow-600 mt-1">üì± Check your phone or authenticator app for the verification code</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Content Niche</label>
                        <select x-model="accountForm.niche" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            <option value="">What content will this account post?</option>
                            <option value="poker">‚ô†Ô∏è Poker Content</option>
                            <option value="slots">üé∞ Slots Content</option>
                            <option value="blackjack">üÉè Blackjack Content</option>
                            <option value="roulette">üé≤ Roulette Content</option>
                            <option value="sports_betting">‚öΩ Sports Betting</option>
                            <option value="crypto_gambling">‚Çø Crypto Gambling</option>
                            <option value="general_gambling">üé∞ General Gambling</option>
                        </select>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                        <h4 class="font-semibold text-green-900 text-sm mb-1">‚úÖ Real Instagram API Active</h4>
                        <p class="text-green-800 text-xs">
                            Using official Instagram API for account verification, video downloading, and uploading. Your credentials are handled securely.
                        </p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <h4 class="font-semibold text-blue-900 text-sm mb-1">üéØ How Niche Targeting Works</h4>
                        <p class="text-blue-800 text-xs">
                            This account will ONLY receive content that matches its niche. Poker accounts get poker content, slots accounts get slots content, etc.
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" @click="showAddAccountModal = false" 
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                        <span x-text="show2FAField ? 'Verify with 2FA Code' : 'Add Upload Account'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function instagramStudio() {
    return {
        // Stats
        get connectedAccounts() {
            return this.instagramAccounts.length;
        },
        get videosDownloaded() {
            return this.videos.filter(v => v.status !== 'pending').length;
        },
        get videosProcessed() {
            return this.videos.filter(v => v.status === 'processed' || v.status === 'uploaded').length;
        },
        get videosUploaded() {
            return this.videos.filter(v => v.status === 'uploaded').length;
        },

        // Data
        instagramAccounts: [],
        videos: [],
        
        // UI State
        showAddAccountModal: false,
        show2FAField: false,
        
        // Forms
        accountForm: {
            username: '',
            password: '',
            verification_code: '',
            niche: ''
        },
        downloadForm: {
            accountUrl: '',
            niche: ''
        },
        processForm: {
            promoTemplate: '',
            customVideoFile: null
        },

        // Methods
        async addAccount() {
            try {
                const response = await fetch('/api/instagram/add-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.accountForm)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Instagram account added successfully!');
                    this.loadAccounts();
                    this.showAddAccountModal = false;
                    this.show2FAField = false;
                    this.accountForm = { username: '', password: '', verification_code: '', niche: '' };
                } else if (result.requires_2fa) {
                    // Show 2FA field and keep modal open
                    this.show2FAField = true;
                    alert('üîê 2FA Required: Please enter the verification code sent to your phone/authenticator app');
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error adding account: ${error.message}`);
            }
        },

        async startDownload() {
            try {
                const response = await fetch('/api/instagram/download-from-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        account_url: this.downloadForm.accountUrl,
                        niche: this.downloadForm.niche
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('üöÄ Started stealing videos!');
                    this.downloadForm = { accountUrl: '', niche: '' };
                    this.loadVideos();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error starting download: ${error.message}`);
            }
        },

        async processAndUploadToNiche() {
            try {
                let customVideoPath = null;
                
                // Upload custom video if selected
                if (this.processForm.promoTemplate === 'custom_video_upload') {
                    if (!this.processForm.customVideoFile) {
                        alert('Please upload your StakeUs! video first');
                        return;
                    }
                    customVideoPath = await this.uploadCustomVideo();
                }
                
                // Process and upload ONLY to matching niche accounts
                const response = await fetch('/api/instagram/process-and-upload-niche', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        promo_template: this.processForm.promoTemplate,
                        custom_video_path: customVideoPath
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`üöÄ NICHE UPLOAD STARTED!\n\n${result.message}\n\nVideos will be processed with StakeUs! and uploaded ONLY to accounts matching the content niche.`);
                    this.loadVideos();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        },

        async editAccount(account) {
            // Pre-fill form with account data
            this.accountForm = {
                username: account.username,
                password: '', // Don't show password
                niche: account.niche
            };
            this.showAddAccountModal = true;
        },

        async deleteAccount(account) {
            if (confirm(`Delete @${account.username} (${account.niche})?\n\nThis cannot be undone.`)) {
                try {
                    const response = await fetch('/api/instagram/delete-account', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ account_id: account.id })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`üóëÔ∏è @${account.username} deleted!`);
                        this.loadAccounts();
                    } else {
                        alert(`‚ùå Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`‚ùå Error deleting account: ${error.message}`);
                }
            }
        },

        async processAndAutoUpload() {
            try {
                let customVideoPath = null;
                
                // Upload custom video if selected
                if (this.processForm.promoTemplate === 'custom_video_upload') {
                    if (!this.processForm.customVideoFile) {
                        alert('Please upload your StakeUs! video first');
                        return;
                    }
                    customVideoPath = await this.uploadCustomVideo();
                }
                
                // Process and auto-upload with scheduling built-in
                const response = await fetch('/api/instagram/process-and-auto-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        promo_template: this.processForm.promoTemplate,
                        custom_video_path: customVideoPath,
                        posts_per_day: 3  // Optimal scheduling built-in
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`üöÄ STARTED!\n\n${result.message}\n\nVideos will be processed with StakeUs! overlay and automatically scheduled to matching niche accounts at optimal times (3 posts/day).`);
                    this.loadVideos();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        },

        async uploadCustomVideo() {
            if (!this.processForm.customVideoFile) return null;
            
            const formData = new FormData();
            formData.append('video', this.processForm.customVideoFile);
            formData.append('type', 'stakeus_overlay');
            
            try {
                const response = await fetch('/api/instagram/upload-overlay-video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    return result.video_path;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error uploading custom video:', error);
                throw error;
            }
        },

        handleVideoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('video/')) {
                    alert('Please select a video file');
                    return;
                }
                
                if (file.size > 50 * 1024 * 1024) {
                    alert('File size must be less than 50MB');
                    return;
                }
                
                this.processForm.customVideoFile = file;
            }
        },

        async loadAccounts() {
            try {
                const response = await fetch('/api/instagram/accounts');
                const accounts = await response.json();
                this.instagramAccounts = accounts;
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        },

        async loadVideos() {
            try {
                const response = await fetch('/api/instagram/videos');
                const videos = await response.json();
                this.videos = videos;
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        },

        getStatusColor(status) {
            const colors = {
                'pending': 'bg-gray-100 text-gray-700',
                'downloading': 'bg-blue-100 text-yellow-700',
                'downloaded': 'bg-green-100 text-green-700',
                'processing': 'bg-amber-100 text-amber-700',
                'processed': 'bg-indigo-100 text-indigo-700',
                'uploading': 'bg-orange-100 text-orange-700',
                'uploaded': 'bg-emerald-100 text-emerald-700'
            };
            return colors[status] || 'bg-gray-100 text-gray-700';
        },

        // Initialize
        init() {
            this.loadAccounts();
            this.loadVideos();
            
            // Refresh every 30 seconds
            setInterval(() => {
                this.loadVideos();
            }, 30000);
        }
    }
}
</script>
{% endblock %}