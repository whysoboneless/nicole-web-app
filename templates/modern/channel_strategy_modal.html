<!-- Channel Content Strategy Modal -->
<div x-data="channelStrategyModal()" 
     x-show="showStrategyModal" 
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
     @click.self="closeStrategyModal()">
    
    <div class="bg-white rounded-xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Content Strategy</h2>
            <button @click="closeStrategyModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Strategy Selection -->
        <div class="space-y-4">
            <!-- Option 1: Campaign Default -->
            <div class="border-2 rounded-lg p-4 cursor-pointer transition-colors"
                 :class="strategySource === 'campaign_default' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'"
                 @click="strategySource = 'campaign_default'">
                <div class="flex items-start space-x-3">
                    <input type="radio" :checked="strategySource === 'campaign_default'" 
                           @change="strategySource = 'campaign_default'"
                           class="mt-1 w-5 h-5 text-indigo-600">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 mb-2">Use Campaign Default</h3>
                        <p class="text-sm text-gray-600 mb-3">Auto-detected from product research</p>
                        <div x-show="strategySource === 'campaign_default' && campaignDefaultStrategy" 
                             class="bg-white rounded p-3 text-sm">
                            <div class="space-y-2">
                                <div>
                                    <span class="font-medium text-gray-700">Audience:</span>
                                    <span class="text-gray-600" x-text="campaignDefaultStrategy.audience || 'N/A'"></span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Content Types:</span>
                                    <span class="text-gray-600" x-text="(campaignDefaultStrategy.content_types || []).join(', ') || 'N/A'"></span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Recommended Styles:</span>
                                    <span class="text-gray-600" x-text="(campaignDefaultStrategy.recommended_styles || []).join(', ') || 'N/A'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Option 2: Existing Group + Content Style -->
            <div class="border-2 rounded-lg p-4 cursor-pointer transition-colors"
                 :class="strategySource === 'group_assigned' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'"
                 @click="strategySource = 'group_assigned'">
                <div class="flex items-start space-x-3">
                    <input type="radio" :checked="strategySource === 'group_assigned'"
                           @change="strategySource = 'group_assigned'"
                           class="mt-1 w-5 h-5 text-indigo-600">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 mb-2">Use Existing Group + Content Style</h3>
                        <p class="text-sm text-gray-600 mb-3">Select from your existing groups and content styles</p>
                        
                        <div x-show="strategySource === 'group_assigned'" class="space-y-4 mt-4">
                            <!-- Group Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Group</label>
                                <select x-model="selectedGroupId" 
                                        @change="loadGroupData()"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select a group...</option>
                                    <template x-for="group in userGroups" :key="group.id">
                                        <option :value="group.id" x-text="group.name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Content Style Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Content Style</label>
                                <select x-model="selectedContentStyleId"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        :disabled="!selectedGroupId">
                                    <option value="">Select a content style...</option>
                                    <template x-for="style in availableContentStyles" :key="style.id">
                                        <option :value="style.id" x-text="style.display_name"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Series Selection -->
                            <div x-show="selectedGroupId && groupSeries.length > 0">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Series</label>
                                <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                    <template x-for="series in groupSeries" :key="series.name">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" 
                                                   :value="series.name"
                                                   x-model="selectedSeries"
                                                   class="w-4 h-4 text-indigo-600 rounded">
                                            <span class="text-sm text-gray-700" x-text="series.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Themes Selection -->
                            <div x-show="selectedGroupId && groupThemes.length > 0">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Themes</label>
                                <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                    <template x-for="theme in groupThemes" :key="theme.name">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" 
                                                   :value="theme.name"
                                                   x-model="selectedThemes"
                                                   class="w-4 h-4 text-indigo-600 rounded">
                                            <span class="text-sm text-gray-700" x-text="theme.name"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Option 3: Create New Group -->
            <div class="border-2 rounded-lg p-4 cursor-pointer transition-colors"
                 :class="strategySource === 'create_group' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'"
                 @click="strategySource = 'create_group'">
                <div class="flex items-start space-x-3">
                    <input type="radio" :checked="strategySource === 'create_group'"
                           @change="strategySource = 'create_group'"
                           class="mt-1 w-5 h-5 text-indigo-600">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 mb-2">Create New Group</h3>
                        <p class="text-sm text-gray-600 mb-3">Create a new group with campaign research data pre-filled</p>
                        <div x-show="strategySource === 'create_group'">
                            <button @click="launchGroupCreation()" 
                                    class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                Launch Group Creation Wizard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
            <button @click="closeStrategyModal()" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
            </button>
            <button @click="saveStrategy()" 
                    :disabled="!canSaveStrategy()"
                    :class="canSaveStrategy() ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                    class="px-6 py-2 rounded-lg transition-colors font-medium">
                Save Strategy
            </button>
        </div>
    </div>
</div>

<script>
function channelStrategyModal() {
    return {
        showStrategyModal: false,
        strategySource: 'campaign_default',
        selectedGroupId: null,
        selectedContentStyleId: null,
        selectedSeries: [],
        selectedThemes: [],
        groupSeries: [],
        groupThemes: [],
        userGroups: [],
        availableContentStyles: [],
        campaignDefaultStrategy: null,
        
        init() {
            // Listen for modal show event
            document.addEventListener('showStrategyModal', (e) => {
                this.loadModalData(e.detail.channelId);
                this.showStrategyModal = true;
            });
        },
        
        loadModalData(channelId) {
            // Load data from window.strategyModalData
            if (window.strategyModalData) {
                this.userGroups = window.strategyModalData.userGroups || [];
                this.availableContentStyles = window.strategyModalData.contentStyles || [];
                this.campaignDefaultStrategy = window.strategyModalData.campaignDefaultStrategy;
                
                if (window.strategyModalData.currentStrategy) {
                    // Editing existing channel
                    const strategy = window.strategyModalData.currentStrategy;
                    this.strategySource = strategy.source || 'campaign_default';
                    this.selectedGroupId = strategy.group_id || null;
                    this.selectedContentStyleId = strategy.content_style_id || null;
                    this.selectedSeries = strategy.series || [];
                    this.selectedThemes = strategy.themes || [];
                    
                    if (this.selectedGroupId) {
                        this.loadGroupData();
                    }
                }
            }
        },
        
        loadGroupData() {
            if (!this.selectedGroupId) return;
            
            // Load series and themes for selected group
            fetch(`/campaigns/api/groups/${this.selectedGroupId}/series-themes`)
                .then(r => r.json())
                .then(data => {
                    this.groupSeries = data.series || [];
                    this.groupThemes = data.themes || [];
                })
                .catch(e => {
                    console.error('Error loading group data:', e);
                });
        },
        
        launchGroupCreation() {
            // Open group creation in new window/tab
            window.open('/create_group?campaign_id={{ campaign._id if campaign else "" }}', '_blank');
        },
        
        canSaveStrategy() {
            if (this.strategySource === 'campaign_default') {
                return true;
            } else if (this.strategySource === 'group_assigned') {
                return this.selectedGroupId && this.selectedContentStyleId;
            } else if (this.strategySource === 'create_group') {
                return false; // Must complete group creation first
            }
            return false;
        },
        
        async saveStrategy() {
            if (!this.canSaveStrategy()) return;
            
            const strategyData = {
                source: this.strategySource,
                group_id: this.strategySource === 'group_assigned' ? this.selectedGroupId : null,
                content_style_id: this.selectedContentStyleId,
                series: this.selectedSeries,
                themes: this.selectedThemes
            };
            
            const channelId = window.strategyModalData?.channelId;
            
            if (channelId) {
                // Update existing channel
                const response = await fetch(`/campaigns/{{ campaign._id }}/channels/${channelId}/set-strategy`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(strategyData)
                });
                
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } else {
                // New channel - store for add channel flow
                window.pendingStrategy = strategyData;
                this.closeStrategyModal();
                // Continue with channel addition flow
                alert('Strategy saved. Continue with channel connection...');
            }
        },
        
        closeStrategyModal() {
            this.showStrategyModal = false;
            this.strategySource = 'campaign_default';
            this.selectedGroupId = null;
            this.selectedContentStyleId = null;
            this.selectedSeries = [];
            this.selectedThemes = [];
            window.strategyModalData = null;
        }
    };
}
</script>

